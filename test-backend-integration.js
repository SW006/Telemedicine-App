// Test script to verify backend integration
const axios = require('axios');

const API_BASE_URL = 'http://localhost:5000/api';

async function testBackendIntegration() {
  console.log('🧪 Testing Backend Integration...\n');

  try {
    // Test 1: Health check
    console.log('1. Testing health check...');
    const healthResponse = await axios.get(`${API_BASE_URL}/health`);
    console.log('✅ Health check passed:', healthResponse.data.message);

    // Test 2: Test user signup (this will store data temporarily and send OTP)
    console.log('\n2. Testing user signup...');
    const timestamp = Date.now();
    const testUser = {
      name: 'Test User',
      email: `test${timestamp}@example.com`,
      password: 'Test123!',
      contact_number: '+1234567890',
      phone: '+1234567890'
    };

    const signupResponse = await axios.post(`${API_BASE_URL}/auth/sign-up`, testUser);
    console.log('✅ Signup successful:', signupResponse.data.message);
    console.log('📧 OTP sent to:', signupResponse.data.email);

    // Test 3: Test OTP verification (using a test OTP)
    console.log('\n3. Testing OTP verification...');
    
    // First, let's check what OTP was generated by looking at the debug endpoint
    try {
      const debugResponse = await axios.get(`${API_BASE_URL}/auth/debug/otp-storage`);
      console.log('📊 Current temp storage:', debugResponse.data);
      
      if (debugResponse.data.storageData && debugResponse.data.storageData[testUser.email]) {
        const testOTP = debugResponse.data.storageData[testUser.email].otp;
        console.log('🔑 Using test OTP:', testOTP);
        
        const verifyResponse = await axios.post(`${API_BASE_URL}/auth/verify-otp`, {
          email: testUser.email,
          otp: testOTP
        });
        console.log('✅ OTP verification successful:', verifyResponse.data.message);
        console.log('🎫 Token generated:', verifyResponse.data.token ? 'Yes' : 'No');
        console.log('👤 User created:', verifyResponse.data.user);
      } else {
        console.log('❌ No temp data found for test user');
      }
    } catch (debugError) {
      console.log('⚠️  Debug endpoint not available, trying with test OTP 123456');
      
      try {
        const verifyResponse = await axios.post(`${API_BASE_URL}/auth/verify-otp`, {
          email: testUser.email,
          otp: '123456'
        });
        console.log('✅ OTP verification successful:', verifyResponse.data.message);
      } catch (verifyError) {
        console.log('❌ OTP verification failed:', verifyError.response?.data?.error || verifyError.message);
      }
    }

    // Test 4: Test doctor signup
    console.log('\n4. Testing doctor signup...');
    const testDoctor = {
      firstName: 'Dr. Test',
      lastName: 'Doctor',
      email: `doctor${timestamp}@example.com`,
      phone: '+1234567891',
      city: 'Test City',
      speciality: 'General Medicine',
      pmdc: `PMDC${timestamp}`,
      experience: '5',
      message: 'Test doctor profile'
    };

    const doctorSignupResponse = await axios.post(`${API_BASE_URL}/auth/doctor-signup`, testDoctor);
    console.log('✅ Doctor signup successful:', doctorSignupResponse.data.message);
    console.log('🎫 Doctor token generated:', doctorSignupResponse.data.data?.token ? 'Yes' : 'No');

    console.log('\n🎉 All tests completed successfully!');
    console.log('\n📋 Summary:');
    console.log('- Backend server is running and responding');
    console.log('- User signup flow works (stores temp data, sends OTP)');
    console.log('- OTP verification works (creates user in database)');
    console.log('- Doctor signup works (creates user and doctor profile)');
    console.log('- Frontend can now successfully integrate with backend');

  } catch (error) {
    console.error('❌ Test failed:', error.response?.data || error.message);
    
    if (error.code === 'ECONNREFUSED') {
      console.log('\n💡 Make sure the backend server is running:');
      console.log('   cd backend && npm start');
    }
  }
}

// Run the test
testBackendIntegration();
